
<p align="center">
  <img src="../../assets/a11y-logo.png" alt="a11y suite logo" width="150"/>
</p>

# a11y-ci

![gate](https://img.shields.io/badge/gate-strict-blue)
![contract](https://img.shields.io/badge/output-low--vision--first-green)
![license](https://img.shields.io/badge/license-MIT-black)

CI gate for `a11y-lint` scorecards. Low-vision-first output.

## Contract

### 1. Input Format
Expects a JSON scorecard generated by `a11y-lint` (or compliant tool).

**Required Schema:**
- `meta.tool`: Tool name
- `meta.version`: Tool version
- `findings`: Array of finding objects (id, severity, location, message)

### 2. Threshold Rules
Fails the build (Exit Code 3) if:
- **Current Run**: Any finding at or above `--fail-on` severity (default: `serious`).
- **Baseline Regression**:
    - Count of serious/critical findings increases.
    - New finding IDs appear (even if count is stable).

### 3. Output Format
- **Stdout**: Human-readable, low-vision accessible summary using `[OK]`, `[WARN]`, `[FAIL]` prefixes.
- **Exit Codes**:
    - `0`: Success (Gate passed)
    - `2`: Input Error (Missing file, invalid JSON schema)
    - `3`: Gate Failed (Threshold exceeded or regression detected)

## Usage

### Check Single Run

```bash
a11y-ci gate --current a11y.scorecard.json
```

### Check Against Baseline

```bash
a11y-ci gate --current a11y.scorecard.json --baseline baseline/a11y.scorecard.json
```

## Install

```bash
pip install .
```

### Allowlist

```bash
a11y-ci gate --current a11y.scorecard.json --baseline baseline/a11y.scorecard.json --allowlist a11y-ci.allowlist.json
```

### Fail severity

```bash
a11y-ci gate --current a11y.scorecard.json --fail-on moderate
```

## Exit codes

| Code | Meaning |
|------|---------|
| 0 | Pass |
| 2 | Input/validation error |
| 3 | Policy gate failed |

## Output Contract

All output follows the low-vision-first contract:

```
[OK] Title (ID: NAMESPACE.CATEGORY.DETAIL)

What:
  What happened.

Why:
  Why it happened.

Fix:
  How to fix it.
```

## Remediation & Help

For common accessibility violations (like missing alt text or color contrast issues), `a11y-ci` now includes direct remediation steps and documentation links in the output:

```
[FAIL] Missing Image Alt Text (A11Y.IMG.ALT)
  Found 3 violations.

  Fix: Add an 'alt' attribute describing the image content.
  Docs: https://github.com/microsoft/accessibility-suite/blob/main/docs/rules.md#a11yimgalt
```

The JSON report (`--json`) also includes these details in the `blocking.details` array, providing `help_url` and `help_hint` for downstream tools.

To add new rules or update existing guidance, edit `src/a11y-ci/a11y_ci/help.py` and `docs/rules.md`.

## Allowlist Format

Allowlist entries require:
- `finding_id`: The rule/finding ID to suppress
- `expires`: ISO date (yyyy-mm-dd) â€” expired entries fail the gate
- `reason`: Minimum 10 chars explaining the suppression

```json
{
  "version": "1",
  "allow": [
    {
      "finding_id": "CLI.COLOR.ONLY",
      "expires": "2026-12-31",
      "reason": "Temporary suppression for legacy output. Tracked in issue #12."
    }
  ]
}
```

## GitHub Actions Example

```yaml
- name: a11y gate
  run: |
    a11y-lint scan output.txt --json > a11y.scorecard.json
    a11y-ci gate --current a11y.scorecard.json --baseline baseline/a11y.scorecard.json
```

## Notes

- This tool is deterministic. It does not call network services.
- Expired allowlist entries fail the gate (no permanent exceptions).
- Scorecards are format-tolerant: reads `summary` when present, otherwise computes from `findings`.

## License

MIT
